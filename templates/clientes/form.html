{% extends "base.html" %}

{% block title %}{{ 'Editar Cliente' if cliente else 'Novo Cliente' }} - Qualicontax{% endblock %}

{% block content %}
<div class="cliente-form-page">
    <!-- Page Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">{{ 'Editar Cliente' if cliente else 'Novo Cliente' }}</h1>
            <p class="page-subtitle">{{ 'Atualize os dados do cliente' if cliente else 'Cadastre um novo cliente no sistema' }}</p>
        </div>
        <div class="page-actions">
            <a href="{{ url_for('clientes.index') }}" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" action="{{ url_for('clientes.editar', id=cliente.id) if cliente else url_for('clientes.novo') }}" class="form-container">
        
        <!-- Informações Básicas -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Informações Básicas</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="numero_cliente">
                            Número do Cliente
                            <span class="text-muted" style="font-size: 12px;">(opcional - ex: 102)</span>
                        </label>
                        <input type="text" 
                               id="numero_cliente" 
                               name="numero_cliente" 
                               class="form-control" 
                               placeholder="Digite o número do cliente (ex: 102)" 
                               value="{{ cliente.numero_cliente if cliente else '' }}"
                               maxlength="20">
                        <small class="form-text text-muted">
                            Deixe em branco para usar apenas o ID automático ou digite um número personalizado (ex: 102 para manter consistência com seus cadastros atuais)
                        </small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo_pessoa">Tipo de Pessoa *</label>
                        <select id="tipo_pessoa" name="tipo_pessoa" class="form-control" required onchange="toggleTipoFields()">
                            <option value="">Selecione...</option>
                            <option value="PF" {% if cliente and cliente.tipo_pessoa == 'PF' %}selected{% endif %}>Pessoa Física</option>
                            <option value="PJ" {% if cliente and cliente.tipo_pessoa == 'PJ' %}selected{% endif %}>Pessoa Jurídica</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="situacao">Situação *</label>
                        <select id="situacao" name="situacao" class="form-control" required>
                            <option value="ATIVO" {% if not cliente or cliente.situacao == 'ATIVO' %}selected{% endif %}>Ativo</option>
                            <option value="INATIVO" {% if cliente and cliente.situacao == 'INATIVO' %}selected{% endif %}>Inativo</option>
                            <option value="SUSPENSO" {% if cliente and cliente.situacao == 'SUSPENSO' %}selected{% endif %}>Suspenso</option>
                            <option value="CANCELADO" {% if cliente and cliente.situacao == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>
                </div>

                <!-- Pessoa Física Fields -->
                <div id="pfFields" style="display: {% if cliente and cliente.tipo_pessoa == 'PF' %}block{% else %}none{% endif %};">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_razao_social_pf">Nome Completo *</label>
                            <input type="text" id="nome_razao_social_pf" name="nome_razao_social" class="form-control" placeholder="Nome completo" value="{{ cliente.nome_razao_social if cliente and cliente.tipo_pessoa == 'PF' else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="cpf_cnpj_pf">CPF *</label>
                            <input type="text" id="cpf_cnpj_pf" name="cpf_cnpj" class="form-control cpf-mask" placeholder="000.000.000-00" value="{{ cliente.cpf_cnpj if cliente and cliente.tipo_pessoa == 'PF' else '' }}">
                        </div>
                    </div>
                </div>

                <!-- Pessoa Jurídica Fields -->
                <div id="pjFields" style="display: {% if cliente and cliente.tipo_pessoa == 'PJ' %}block{% else %}none{% endif %};">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome_razao_social_pj">Razão Social *</label>
                            <input type="text" id="nome_razao_social_pj" name="nome_razao_social" class="form-control" placeholder="Razão social da empresa" value="{{ cliente.nome_razao_social if cliente and cliente.tipo_pessoa == 'PJ' else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="nome_fantasia">Nome Fantasia</label>
                            <input type="text" id="nome_fantasia" name="nome_fantasia" class="form-control" placeholder="Nome fantasia" value="{{ cliente.nome_fantasia if cliente else '' }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cpf_cnpj_pj">CNPJ *</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="cpf_cnpj_pj" name="cpf_cnpj" class="form-control cnpj-mask" placeholder="00.000.000/0000-00" value="{{ cliente.cpf_cnpj if cliente and cliente.tipo_pessoa == 'PJ' else '' }}" style="flex: 1;">
                                <button type="button" id="btnConsultarCNPJ" class="btn btn-info" onclick="consultarCNPJ()" style="white-space: nowrap;">
                                    <i class="fas fa-search"></i> Consultar CNPJ
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Digite o CNPJ e clique em "Consultar CNPJ" para preencher automaticamente os dados da Receita Federal
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="inscricao_estadual">Inscrição Estadual</label>
                            <input type="text" id="inscricao_estadual" name="inscricao_estadual" class="form-control" placeholder="Inscrição Estadual" value="{{ cliente.inscricao_estadual if cliente else '' }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inscricao_municipal">Inscrição Municipal</label>
                            <input type="text" id="inscricao_municipal" name="inscricao_municipal" class="form-control" placeholder="Inscrição Municipal" value="{{ cliente.inscricao_municipal if cliente else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="regime_tributario">Regime Tributário</label>
                            <select id="regime_tributario" name="regime_tributario" class="form-control">
                                <option value="">Selecione...</option>
                                <option value="SIMPLES" {% if cliente and cliente.regime_tributario == 'SIMPLES' %}selected{% endif %}>Simples Nacional</option>
                                <option value="LUCRO_PRESUMIDO" {% if cliente and cliente.regime_tributario == 'LUCRO_PRESUMIDO' %}selected{% endif %}>Lucro Presumido</option>
                                <option value="LUCRO_REAL" {% if cliente and cliente.regime_tributario == 'LUCRO_REAL' %}selected{% endif %}>Lucro Real</option>
                                <option value="MEI" {% if cliente and cliente.regime_tributario == 'MEI' %}selected{% endif %}>MEI</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="porte_empresa">Porte da Empresa</label>
                            <select id="porte_empresa" name="porte_empresa" class="form-control">
                                <option value="">Selecione...</option>
                                <option value="MEI" {% if cliente and cliente.porte_empresa == 'MEI' %}selected{% endif %}>MEI</option>
                                <option value="ME" {% if cliente and cliente.porte_empresa == 'ME' %}selected{% endif %}>Microempresa (ME)</option>
                                <option value="EPP" {% if cliente and cliente.porte_empresa == 'EPP' %}selected{% endif %}>Empresa de Pequeno Porte (EPP)</option>
                                <option value="MEDIO" {% if cliente and cliente.porte_empresa == 'MEDIO' %}selected{% endif %}>Médio Porte</option>
                                <option value="GRANDE" {% if cliente and cliente.porte_empresa == 'GRANDE' %}selected{% endif %}>Grande Porte</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ramos de Atividade</label>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background-color: #f9f9f9;">
                                {% if ramos_atividade %}
                                    {% for ramo in ramos_atividade %}
                                    <div class="form-check" style="margin-bottom: 8px;">
                                        <input class="form-check-input" type="checkbox" 
                                               name="ramos_atividade_ids" 
                                               value="{{ ramo.id }}" 
                                               id="ramo_{{ ramo.id }}"
                                               {% if ramos_cliente and ramo.id in ramos_cliente %}checked{% endif %}>
                                        <label class="form-check-label" for="ramo_{{ ramo.id }}" style="margin-left: 5px;">
                                            {{ ramo.nome }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted" style="margin: 0;">Nenhum ramo de atividade cadastrado.</p>
                                {% endif %}
                            </div>
                            <small class="form-text text-muted">
                                Selecione um ou mais ramos de atividade. Ex: Posto de Gasolina, Distribuidora, Transportadoras, Lava Rápido, etc.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contato -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Informações de Contato</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" class="form-control" placeholder="email@exemplo.com" value="{{ cliente.email if cliente else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="telefone">Telefone</label>
                        <input type="text" id="telefone" name="telefone" class="form-control phone-mask" placeholder="(00) 0000-0000" value="{{ cliente.telefone if cliente else '' }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="celular">Celular</label>
                        <input type="text" id="celular" name="celular" class="form-control phone-mask" placeholder="(00) 00000-0000" value="{{ cliente.celular if cliente else '' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Endereço -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Endereço</h3>
                <small class="text-muted">Opcional - será preenchido automaticamente ao consultar CNPJ</small>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cep">CEP</label>
                        <input type="text" id="cep" name="cep" class="form-control" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="form-group">
                        <label for="logradouro">Logradouro</label>
                        <input type="text" id="logradouro" name="logradouro" class="form-control" placeholder="Rua, Avenida, etc.">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="numero">Número</label>
                        <input type="text" id="numero" name="numero" class="form-control" placeholder="Número">
                    </div>
                    <div class="form-group">
                        <label for="complemento">Complemento</label>
                        <input type="text" id="complemento" name="complemento" class="form-control" placeholder="Apto, Sala, etc.">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="bairro">Bairro</label>
                        <input type="text" id="bairro" name="bairro" class="form-control" placeholder="Bairro">
                    </div>
                    <div class="form-group">
                        <label for="cidade">Cidade</label>
                        <input type="text" id="cidade" name="cidade" class="form-control" placeholder="Cidade">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <select id="estado" name="estado" class="form-control">
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados do Contrato -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Dados do Contrato</h3>
            </div>
            <div class="card-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="data_inicio_contrato">Data Início do Contrato</label>
                        <input type="date" id="data_inicio_contrato" name="data_inicio_contrato" class="form-control" value="{{ cliente.data_inicio_contrato if cliente else '' }}">
                    </div>
                    <div class="form-group">
                        <label for="data_fim_contrato">Data Fim do Contrato</label>
                        <input type="date" id="data_fim_contrato" name="data_fim_contrato" class="form-control" value="{{ cliente.data_fim_contrato if cliente else '' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Observações -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Observações</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="observacoes">Observações</label>
                    <textarea id="observacoes" name="observacoes" class="form-control" rows="4" placeholder="Observações adicionais sobre o cliente">{{ cliente.observacoes if cliente else '' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Grupos (apenas em edição) -->
        {% if cliente and grupos %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Grupos</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">Para gerenciar grupos, acesse a aba "Grupos" na página de detalhes do cliente.</p>
                {% if grupos_cliente %}
                <div class="badges-list">
                    {% for grupo in grupos_cliente %}
                    <span class="badge badge-info badge-lg">{{ grupo.nome }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('clientes.index') }}" class="btn btn-outline">
                <i class="fas fa-times"></i>
                Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                {{ 'Atualizar Cliente' if cliente else 'Cadastrar Cliente' }}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle fields based on tipo_pessoa
function toggleTipoFields() {
    const tipoPessoa = document.getElementById('tipo_pessoa').value;
    const pfFields = document.getElementById('pfFields');
    const pjFields = document.getElementById('pjFields');
    
    if (tipoPessoa === 'PF') {
        pfFields.style.display = 'block';
        pjFields.style.display = 'none';
        
        // Make PF fields required
        document.getElementById('nome_razao_social_pf').required = true;
        document.getElementById('cpf_cnpj_pf').required = true;
        
        // Make PJ fields not required
        document.getElementById('nome_razao_social_pj').required = false;
        document.getElementById('cpf_cnpj_pj').required = false;
    } else if (tipoPessoa === 'PJ') {
        pfFields.style.display = 'none';
        pjFields.style.display = 'block';
        
        // Make PJ fields required
        document.getElementById('nome_razao_social_pj').required = true;
        document.getElementById('cpf_cnpj_pj').required = true;
        
        // Make PF fields not required
        document.getElementById('nome_razao_social_pf').required = false;
        document.getElementById('cpf_cnpj_pf').required = false;
    } else {
        pfFields.style.display = 'none';
        pjFields.style.display = 'none';
    }
}

// Call on page load if editing
document.addEventListener('DOMContentLoaded', function() {
    toggleTipoFields();
    
    // Convert name fields to UPPERCASE automatically
    const nameFields = [
        document.getElementById('nome_razao_social_pf'),
        document.getElementById('nome_razao_social_pj'),
        document.getElementById('nome_fantasia')
    ];
    
    nameFields.forEach(field => {
        if (field) {
            // Apply uppercase CSS
            field.style.textTransform = 'uppercase';
            
            // Convert on input
            field.addEventListener('input', function(e) {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = e.target.value.toUpperCase();
                e.target.setSelectionRange(start, end);
            });
        }
    });
    
    // Simple input masks (could be improved with a library)
    const cpfInputs = document.querySelectorAll('.cpf-mask');
    const cnpjInputs = document.querySelectorAll('.cnpj-mask');
    const phoneInputs = document.querySelectorAll('.phone-mask');
    
    // CPF mask
    cpfInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            }
            
            e.target.value = value;
        });
    });
    
    // CNPJ mask
    cnpjInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 14) value = value.slice(0, 14);
            
            if (value.length > 12) {
                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            } else if (value.length > 8) {
                value = value.replace(/(\d{2})(\d{3})(\d{3})(\d{1,4})/, '$1.$2.$3/$4');
            } else if (value.length > 5) {
                value = value.replace(/(\d{2})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{1,3})/, '$1.$2');
            }
            
            e.target.value = value;
        });
    });
    
    // Phone mask
    phoneInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.slice(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d{1,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{1,5})/, '($1) $2');
            }
            
            e.target.value = value;
        });
    });
    
    // CEP mask
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.slice(0, 8);
            
            if (value.length > 5) {
                value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
            }
            
            e.target.value = value;
        });
    }
});

// Validate dates
document.querySelector('form').addEventListener('submit', function(e) {
    const dataInicio = document.getElementById('data_inicio_contrato').value;
    const dataFim = document.getElementById('data_fim_contrato').value;
    
    if (dataInicio && dataFim && dataFim < dataInicio) {
        e.preventDefault();
        alert('A data de fim do contrato não pode ser anterior à data de início.');
        return false;
    }
});

// Função para consultar CNPJ na Receita Federal
function consultarCNPJ() {
    const cnpjInput = document.getElementById('cpf_cnpj_pj');
    const cnpj = cnpjInput.value.replace(/\D/g, '');
    
    if (!cnpj || cnpj.length !== 14) {
        alert('Por favor, digite um CNPJ válido com 14 dígitos.');
        cnpjInput.focus();
        return;
    }
    
    const btn = document.getElementById('btnConsultarCNPJ');
    const btnOriginalHTML = btn.innerHTML;
    
    // Mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Consultando...';
    
    // Fazer requisição
    fetch(`/api/consultar-cnpj/${cnpj}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Confirmar preenchimento
                if (confirm('Dados encontrados! Deseja preencher automaticamente os campos com as informações da Receita Federal?')) {
                    preencherDadosCNPJ(data.data);
                }
            } else {
                alert(data.message || 'Erro ao consultar CNPJ. Verifique o número e tente novamente.');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao consultar CNPJ. Verifique sua conexão e tente novamente.');
        })
        .finally(() => {
            // Restaurar botão
            btn.disabled = false;
            btn.innerHTML = btnOriginalHTML;
        });
}

// Função para preencher os campos com dados da Receita
function preencherDadosCNPJ(data) {
    console.log('=== DADOS RECEBIDOS DA API ===', data); // DEBUG
    
    // Dados básicos
    if (data.razao_social) {
        document.getElementById('nome_razao_social_pj').value = data.razao_social;
    }
    if (data.nome_fantasia) {
        document.getElementById('nome_fantasia').value = data.nome_fantasia;
    }
    
    // Converter porte para o formato do sistema
    if (data.porte) {
        const porteMap = {
            'ME': 'ME',
            'EPP': 'EPP',
            'DEMAIS': 'MEDIO',
            'MICRO EMPRESA': 'ME',
            'EMPRESA DE PEQUENO PORTE': 'EPP'
        };
        const porte = porteMap[data.porte.toUpperCase()] || '';
        if (porte) {
            document.getElementById('porte_empresa').value = porte;
        }
    }
    
    // Data de início (converter de YYYY-MM-DD para formato do input)
    if (data.data_inicio_atividade) {
        // A API retorna no formato DD/MM/YYYY, converter para YYYY-MM-DD
        const partes = data.data_inicio_atividade.split('/');
        if (partes.length === 3) {
            const dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
            document.getElementById('data_inicio_contrato').value = dataFormatada;
        }
    }
    
    // ===== NOVOS CAMPOS =====
    
    // Email - com debug detalhado
    console.log('Email recebido:', data.email, '| Tipo:', typeof data.email); // DEBUG
    if (data.email && data.email.trim && data.email.trim() !== '') {
        const emailField = document.getElementById('email');
        if (emailField) {
            emailField.value = data.email.toLowerCase().trim();
            console.log('✅ Email preenchido com sucesso:', emailField.value); // DEBUG
        } else {
            console.error('❌ Campo #email não encontrado no DOM'); // DEBUG
        }
    } else {
        console.warn('⚠️ Email não disponível ou vazio na resposta da API'); // DEBUG
    }
    
    // Telefones
    if (data.ddd_telefone_1) {
        const telefone1 = data.ddd_telefone_1.replace(/\D/g, '');
        if (telefone1.length >= 10) {
            // Formatar telefone
            let telFormatado;
            if (telefone1.length === 10) {
                telFormatado = telefone1.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else {
                telFormatado = telefone1.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            document.getElementById('telefone').value = telFormatado;
        }
    }
    
    if (data.ddd_telefone_2) {
        const telefone2 = data.ddd_telefone_2.replace(/\D/g, '');
        if (telefone2.length >= 10) {
            // Formatar telefone
            let telFormatado;
            if (telefone2.length === 10) {
                telFormatado = telefone2.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else {
                telFormatado = telefone2.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            document.getElementById('celular').value = telFormatado;
        }
    }
    
    // Endereço
    if (data.cep) {
        const cepFormatado = data.cep.replace(/\D/g, '').replace(/(\d{5})(\d{3})/, '$1-$2');
        document.getElementById('cep').value = cepFormatado;
    }
    
    if (data.logradouro) {
        document.getElementById('logradouro').value = data.logradouro;
    }
    
    if (data.numero) {
        document.getElementById('numero').value = data.numero;
    }
    
    if (data.complemento) {
        document.getElementById('complemento').value = data.complemento;
    }
    
    if (data.bairro) {
        document.getElementById('bairro').value = data.bairro;
    }
    
    if (data.municipio) {
        document.getElementById('cidade').value = data.municipio;
    }
    
    if (data.uf) {
        document.getElementById('estado').value = data.uf;
    }
    
    // Exibir mensagem de sucesso
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
        <strong>✅ Dados preenchidos com sucesso!</strong> Os dados foram obtidos da Receita Federal, incluindo:
        <ul style="margin: 10px 0 0 0; padding-left: 20px;">
            <li>Razão Social e Nome Fantasia</li>
            <li>E-mail e Telefones</li>
            <li>Endereço completo</li>
            <li>Porte e Data de Início</li>
        </ul>
        Revise as informações e complete os campos restantes.
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    `;
    
    const form = document.querySelector('form');
    form.insertBefore(alertDiv, form.firstChild);
    
    // Auto-remover alerta após 8 segundos
    setTimeout(() => {
        alertDiv.remove();
    }, 8000);
    
    // Scroll para o topo
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %}
